# çœŸå®å¡åŒ…å›¾ç‰‡ç³»ç»Ÿè®¾è®¡

## ğŸ“‹ ç›®å½•

- [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
- [æ ¸å¿ƒåŸåˆ™](#æ ¸å¿ƒåŸåˆ™)
- [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
- [æ•°æ®ç»“æ„](#æ•°æ®ç»“æ„)
- [åˆ†æµç­–ç•¥](#åˆ†æµç­–ç•¥)
- [æ ¸å¿ƒæ¥å£](#æ ¸å¿ƒæ¥å£)
- [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
- [å¯¼å…¥å¯¼å‡ºæµç¨‹](#å¯¼å…¥å¯¼å‡ºæµç¨‹)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## è®¾è®¡ç›®æ ‡

### é—®é¢˜èƒŒæ™¯

ç³»ç»Ÿéœ€è¦æ”¯æŒä¸¤ç§å®Œå…¨ä¸åŒçš„å›¾ç‰‡ç®¡ç†åœºæ™¯ï¼š

1. **å¡ç‰Œç¼–è¾‘å™¨** - ç”¨æˆ·æ­£åœ¨åˆ›å»º/ç¼–è¾‘çš„å¡åŒ…
   - å•ä¸€ç¼–è¾‘ç¯å¢ƒ
   - é¢‘ç¹çš„å•å¡ä¿®æ”¹
   - éœ€è¦å®æ—¶é¢„è§ˆ

2. **çœŸå®å¡åŒ…ç³»ç»Ÿ** - å·²å¯¼å…¥çš„å®Œæ•´å¡åŒ…
   - å¤šæ‰¹æ¬¡ç®¡ç†
   - æ‰¹æ¬¡çº§åŸå­æ“ä½œ
   - **å¯¼å…¥åä¸å†ä¿®æ”¹**

### è®¾è®¡ç›®æ ‡

âœ… **å®Œå…¨éš”ç¦»** - ç¼–è¾‘å™¨å’ŒçœŸå®å¡åŒ…ä½¿ç”¨ç‹¬ç«‹çš„è¡¨å’Œæ¥å£
âœ… **è‡ªåŠ¨åˆ†æµ** - æ ¹æ®å¡ç‰Œç±»å‹è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„è¯»å–æ–¹å¼
âœ… **æ‰¹æ¬¡åŸå­** - çœŸå®å¡åŒ…çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ‰¹æ¬¡çº§äº‹åŠ¡
âœ… **æç®€é”®è®¾è®¡** - ç›´æ¥ä½¿ç”¨ `cardId`ï¼Œæ— éœ€æ‰¹æ¬¡å‰ç¼€ï¼ˆcardId å·²åŒ…å« packageName + authorï¼Œå…¨å±€å”¯ä¸€ï¼‰

---

## æ ¸å¿ƒåŸåˆ™

### 1. åŒè¡¨éš”ç¦»

| è¡¨å | ç”¨é€” | é”®æ ¼å¼ | åœºæ™¯ |
|------|------|--------|------|
| `editorImages` | ç¼–è¾‘å™¨å›¾ç‰‡ | `cardId` | å¡ç‰Œç¼–è¾‘å™¨ä¸“ç”¨ |
| `images` | çœŸå®å¡åŒ…å›¾ç‰‡ | `cardId` | å·²å¯¼å…¥çš„å¡åŒ… |

### 2. ç±»å‹é©±åŠ¨åˆ†æµ

**åˆ¤æ–­ä¾æ®**: `ExtendedStandardCard.batchId` å­—æ®µ

```typescript
interface ExtendedStandardCard extends StandardCard {
  source?: CardSource;
  batchId?: string;      // âœ… åˆ†æµçš„å…³é”®å­—æ®µ
  batchName?: string;
}
```

**åˆ†æµè§„åˆ™**:
- `batchId` **ä¸å­˜åœ¨** â†’ ç¼–è¾‘å™¨å¡ç‰Œ â†’ è¯»å– `editorImages` è¡¨
- `batchId` **å­˜åœ¨** â†’ çœŸå®å¡åŒ…å¡ç‰Œ â†’ è¯»å– `images` è¡¨

### 3. èŒè´£åˆ†ç¦»

| å‡½æ•° | èŒè´£ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `getImageUrlFromDB(cardId)` | ç¼–è¾‘å™¨å›¾ç‰‡è¯»å– | ä»…é™ç¼–è¾‘å™¨å†…éƒ¨ |
| `store.getImageUrl(cardId)` | çœŸå®å¡åŒ…å›¾ç‰‡è¯»å–ï¼ˆå¸¦ç¼“å­˜ï¼‰ | é€šç”¨å›¾ç‰‡è¯»å– |
| `getCardImageUrlAsync(card)` | é€šç”¨é¢„è§ˆå±‚ | è‡ªåŠ¨åˆ†æµ |

### 4. cardId å…¨å±€å”¯ä¸€æ€§

**cardId æ ¼å¼**: `${packageName}-${author}-${typeCode}-${suffix}`

**ç¤ºä¾‹**:
- ç¼–è¾‘å™¨å¡ç‰Œ: `mypack-john-prof-warrior`
- çœŸå®å¡åŒ…: `official-core-criticalrole-prof-ranger`

**å…³é”®ç‚¹**:
- âœ… cardId åŒ…å«äº† packageName å’Œ author
- âœ… ä¸åŒå¡åŒ…çš„å¡ç‰Œ cardId ä¸ä¼šå†²çª
- âœ… å¯ä»¥ç›´æ¥ä½¿ç”¨ cardId ä½œä¸º IndexedDB é”®ï¼Œæ— éœ€ batchId å‰ç¼€

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é€šç”¨é¢„è§ˆå±‚                              â”‚
â”‚                 getCardImageUrlAsync(card)                   â”‚
â”‚                                                               â”‚
â”‚                  åˆ¤æ–­: card.batchId?                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                â”‚
           æœ‰ batchIdâ”‚                â”‚æ—  batchId
                     â†“                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   çœŸå®å¡åŒ…åˆ†æ”¯   â”‚   â”‚   ç¼–è¾‘å™¨åˆ†æ”¯    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                    â”‚
                 â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ store.getImageUrl() â”‚  â”‚ getImageUrlFromDBâ”‚
    â”‚                     â”‚  â”‚                  â”‚
    â”‚ 1. æ£€æŸ¥ editorImagesâ”‚  â”‚ ç›´æ¥è¯»å–:        â”‚
    â”‚ 2. è¯»å– images è¡¨   â”‚  â”‚ editorImages.get â”‚
    â”‚    (é”® = cardId)    â”‚  â”‚      (cardId)    â”‚
    â”‚ 3. ç¼“å­˜ç»“æœ         â”‚  â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                    â”‚
                 â†“                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         IndexedDB                 â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
        â”‚  â”‚ images       â”‚ editorImages  â”‚â”‚
        â”‚  â”‚ é”®: cardId   â”‚ é”®: cardId    â”‚â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®ç»“æ„

### IndexedDB Schema

```typescript
Database: "card-images"

{
  // çœŸå®å¡åŒ…å›¾ç‰‡è¡¨
  images: {
    key: string,        // ä¸»é”®: "cardId" (ç›´æ¥ä½¿ç”¨å¡ç‰ŒID)
    blob: Blob,
    mimeType: string,
    size: number,
    createdAt: number
  },

  // ç¼–è¾‘å™¨å›¾ç‰‡è¡¨
  editorImages: {
    key: string,        // ä¸»é”®: "cardId"
    blob: Blob,
    mimeType: string,
    size: number,
    createdAt: number
  }

  // æ³¨æ„: ä¸å†éœ€è¦ batchRegistry è¡¨
  // æ‰¹æ¬¡ä¿¡æ¯ï¼ˆåŒ…æ‹¬å›¾ç‰‡IDåˆ—è¡¨ï¼‰å­˜å‚¨åœ¨ localStorage ä¸­
}
```

### æ‰¹æ¬¡å…ƒä¿¡æ¯ï¼ˆlocalStorageï¼‰

```typescript
// å­˜å‚¨é”®: daggerheart_custom_cards_batch_{batchId}
interface BatchInfo {
  id: string;              // æ‰¹æ¬¡ID
  name: string;            // æ‰¹æ¬¡åç§°
  fileName: string;        // åŸå§‹æ–‡ä»¶å
  importTime: string;      // å¯¼å…¥æ—¶é—´
  version?: string;
  description?: string;
  author?: string;
  cardCount: number;       // å¡ç‰Œæ€»æ•°
  cardTypes: string[];     // å¡ç‰Œç±»å‹åˆ—è¡¨
  cardIds: string[];       // æ‰€æœ‰å¡ç‰ŒIDåˆ—è¡¨
  imageCardIds: string[];  // âœ… æœ‰å›¾ç‰‡çš„å¡ç‰ŒIDåˆ—è¡¨ï¼ˆç”¨äºåˆ é™¤ï¼‰
  size: number;            // æ•°æ®å¤§å°
}
```

### å¡ç‰Œæ•°æ®ç»“æ„

```typescript
// ç¼–è¾‘å™¨å¡ç‰Œ
{
  id: "pack-author-prof-warrior",
  name: "æˆ˜å£«",
  imageUrl: "db://pack-author-prof-warrior",
  // æ³¨æ„: æ²¡æœ‰ batchId å­—æ®µ
}

// çœŸå®å¡åŒ…å¡ç‰Œ
{
  id: "official-prof-ranger",
  name: "æ¸¸ä¾ ",
  imageUrl: "db://official-prof-ranger",
  batchId: "official_core",          // âœ… å…³é”®å­—æ®µ
  batchName: "Official Core Cards",
  source: "custom"
}
```

---

## åˆ†æµç­–ç•¥

### åˆ¤æ–­é€»è¾‘

```typescript
function getImageSource(card: StandardCard): 'editor' | 'realBatch' | 'none' {
  const extendedCard = card as ExtendedStandardCard;

  if (!card.imageUrl?.startsWith('db://')) {
    return 'none'; // ä¸æ˜¯ IndexedDB å›¾ç‰‡
  }

  if (extendedCard.batchId) {
    return 'realBatch'; // çœŸå®å¡åŒ…å›¾ç‰‡
  }

  return 'editor'; // ç¼–è¾‘å™¨å›¾ç‰‡
}
```

### åˆ†æµè¡¨

| åœºæ™¯ | `card.batchId` | `card.imageUrl` | è¯»å–å‡½æ•° | æŸ¥è¯¢è¡¨ |
|------|---------------|----------------|---------|--------|
| ç¼–è¾‘å™¨å¡ç‰Œ | `undefined` | `db://cardId` | `getImageUrlFromDB(cardId)` | `editorImages` |
| çœŸå®å¡åŒ…å¡ç‰Œ | `"official_core"` | `db://cardId` | `store.getImageUrl(cardId)` | `images` |
| æ™®é€šå›¾ç‰‡ | - | `/image/xxx.webp` | ç›´æ¥ä½¿ç”¨è·¯å¾„ | - |

---

## æ ¸å¿ƒæ¥å£

### 1. ç¼–è¾‘å™¨å›¾ç‰‡è¯»å–ï¼ˆç‹¬ç«‹ï¼‰

**å‡½æ•°**: `getImageUrlFromDB(cardId: string)`
**ä½ç½®**: `app/card-editor/utils/image-db-helpers.ts`
**ç”¨é€”**: ä»…ç”¨äºå¡ç‰Œç¼–è¾‘å™¨å†…éƒ¨

```typescript
/**
 * è·å–ç¼–è¾‘å™¨å›¾ç‰‡çš„ä¸´æ—¶ URL
 * æ³¨æ„: ä»…ç”¨äºç¼–è¾‘å™¨ç¯å¢ƒ
 */
export async function getImageUrlFromDB(cardId: string): Promise<string | null> {
  try {
    const db = getCardImageDB();
    const record = await db.editorImages.get(cardId);

    if (record) {
      return URL.createObjectURL(record.blob);
    }

    return null;
  } catch (error) {
    console.error('[ImageDB] Failed to get image URL:', error);
    return null;
  }
}
```

### 2. çœŸå®å¡åŒ…å›¾ç‰‡è¯»å–ï¼ˆStoreæ–¹æ³•ï¼‰

**å‡½æ•°**: `store.getImageUrl(cardId: string)`
**ä½ç½®**: `card/stores/image-service-actions.ts`
**ç”¨é€”**: é€šç”¨å›¾ç‰‡è¯»å–ï¼ˆè‡ªåŠ¨åˆ†æµç¼–è¾‘å™¨å’ŒçœŸå®å¡åŒ…ï¼‰

```typescript
/**
 * è·å–å›¾ç‰‡URLï¼ˆå¸¦ç¼“å­˜ï¼‰
 * è‡ªåŠ¨å¤„ç†ç¼–è¾‘å™¨å›¾ç‰‡å’ŒçœŸå®å¡åŒ…å›¾ç‰‡
 *
 * @param cardId å¡ç‰ŒID
 * @returns Blob URL æˆ– null
 */
getImageUrl: async (cardId: string): Promise<string | null> => {
  const state = get();

  if (!state.imageService.initialized) {
    console.warn('[getImageUrl] Image service not initialized');
    return null;
  }

  const db = state.imageService.db!;

  try {
    // 1. ä¼˜å…ˆæ£€æŸ¥ç¼–è¾‘å™¨è¡¨ï¼ˆç¼–è¾‘ä¸­çš„å¡ç‰Œï¼‰
    const editorRecord = await db.editorImages.get(cardId);
    if (editorRecord) {
      return URL.createObjectURL(editorRecord.blob);
    }

    // 2. æ£€æŸ¥å¡ç‰Œæ˜¯å¦å±äºçœŸå®å¡åŒ…
    const card = state.cards.get(cardId);
    if (!card?.batchId) {
      console.warn(`[getImageUrl] Card not found or missing batchId: ${cardId}`);
      return null;
    }

    // 3. ä»çœŸå®å¡åŒ…è¡¨è¯»å–ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    const { getCachedImageUrl } = await import('./image-service');

    return getCachedImageUrl(
      cardId,  // âœ… ç›´æ¥ä½¿ç”¨ cardId ä½œä¸ºé”®
      state.imageCache,
      (updater) => set(state => ({
        imageCache: updater(state.imageCache)
      }))
    );

  } catch (error) {
    console.error(`[getImageUrl] Failed to get image for ${cardId}:`, error);
    return null;
  }
}
```

### 3. é€šç”¨é¢„è§ˆå±‚ï¼ˆè‡ªåŠ¨åˆ†æµï¼‰

**å‡½æ•°**: `getCardImageUrlAsync(card: StandardCard)`
**ä½ç½®**: `lib/utils.ts`
**ç”¨é€”**: æ‰€æœ‰é¢„è§ˆç»„ä»¶ä½¿ç”¨

```typescript
/**
 * å¼‚æ­¥è·å–å¡ç‰Œå›¾ç‰‡URLï¼ˆè‡ªåŠ¨åˆ†æµï¼‰
 * æ ¹æ® card.batchId è‡ªåŠ¨åˆ¤æ–­æ˜¯ç¼–è¾‘å™¨å›¾ç‰‡è¿˜æ˜¯çœŸå®å¡åŒ…å›¾ç‰‡
 */
export async function getCardImageUrlAsync(
  card: StandardCard | undefined,
  isError: boolean = false
): Promise<string> {
  const basePath = getBasePath();

  if (isError || !card) {
    return `${basePath}/image/empty-card.webp`;
  }

  let imageUrl = card.imageUrl;

  // å°è¯•ä» store æŸ¥æ‰¾å®Œæ•´å¡ç‰Œæ•°æ®
  if (!imageUrl && card.id) {
    const store = useUnifiedCardStore.getState();
    if (store.initialized) {
      const foundCard = store.getCardById(card.id);
      if (foundCard?.imageUrl) {
        imageUrl = foundCard.imageUrl;
      }
    }
  }

  // å¤„ç† db:// å‰ç¼€ï¼ˆIndexedDB å›¾ç‰‡ï¼‰
  if (imageUrl?.startsWith('db://')) {
    const cardId = imageUrl.substring(5); // ç§»é™¤ "db://" å‰ç¼€

    try {
      // ç±»å‹è½¬æ¢æ£€æŸ¥ batchId
      const extendedCard = card as any;

      if (extendedCard.batchId) {
        // çœŸå®å¡åŒ…åˆ†æ”¯ - ä½¿ç”¨ unified-card-store
        const store = useUnifiedCardStore.getState();
        const blobUrl = await store.getImageUrl(cardId);

        if (blobUrl) {
          return blobUrl;
        }

        console.warn(`[getCardImageUrlAsync] Real card image not found: ${cardId}`);
        return `${basePath}/image/empty-card.webp`;

      } else {
        // ç¼–è¾‘å™¨åˆ†æ”¯ - ä½¿ç”¨ç¼–è¾‘å™¨ä¸“ç”¨å‡½æ•°
        const { getImageUrlFromDB } = await import('@/app/card-editor/utils/image-db-helpers');
        const blobUrl = await getImageUrlFromDB(cardId);

        if (blobUrl) {
          return blobUrl;
        }

        console.warn(`[getCardImageUrlAsync] Editor image not found: ${cardId}`);
        return `${basePath}/image/empty-card.webp`;
      }

    } catch (error) {
      console.error(`[getCardImageUrlAsync] Failed to load image ${cardId}:`, error);
      return `${basePath}/image/empty-card.webp`;
    }
  }

  // å…¶ä»–ç±»å‹çš„ imageUrlï¼ˆç›¸å¯¹è·¯å¾„ç­‰ï¼‰
  if (!imageUrl) {
    return `${basePath}/image/empty-card.webp`;
  }

  // ... å¤„ç†å…¶ä»–è·¯å¾„æ ¼å¼
}
```

---

## å®ç°ç»†èŠ‚

### 1. æ‰¹æ¬¡çº§å¯¼å…¥ï¼ˆåŸå­äº‹åŠ¡ï¼‰

**å‡½æ•°**: `importBatchImages(batchId, batchName, cards, images)`
**ä½ç½®**: `card/stores/image-service/image-manager.ts`

```typescript
/**
 * æ‰¹æ¬¡å¯¼å…¥å›¾ç‰‡ï¼ˆåŸå­äº‹åŠ¡ï¼‰
 *
 * @param batchId æ‰¹æ¬¡ID
 * @param batchName æ‰¹æ¬¡åç§°
 * @param cards å¡ç‰Œæ•°æ®æ•°ç»„
 * @param images å›¾ç‰‡Map (key: cardId, value: Blob)
 * @returns å¯¼å…¥ç»“æœï¼ˆåŒ…å« imageCardIds åˆ—è¡¨ï¼‰
 */
export async function importBatchImages(
  batchId: string,
  batchName: string,
  cards: ExtendedStandardCard[],
  images: Map<string, Blob>
): Promise<BatchImportResult> {
  const db = getCardImageDB();

  try {
    const result = await db.transaction(
      'rw',
      db.images,  // åªéœ€è¦ images è¡¨ï¼Œä¸éœ€è¦ batchRegistry
      async () => {
        const imageRecords: ImageRecord[] = [];
        const imageCardIds: string[] = [];  // âœ… è®°å½•æœ‰å›¾ç‰‡çš„å¡ç‰ŒID
        let totalSize = 0;
        const updatedCards: ExtendedStandardCard[] = [];

        // å‡†å¤‡å›¾ç‰‡è®°å½•
        for (const card of cards) {
          const blob = images.get(card.id);

          if (blob) {
            // âœ… ç›´æ¥ä½¿ç”¨ cardId ä½œä¸ºé”®ï¼ˆæ—  batchId å‰ç¼€ï¼‰
            const imageKey = card.id;

            imageRecords.push({
              key: imageKey,
              blob: blob,
              mimeType: blob.type || 'image/webp',
              size: blob.size,
              createdAt: Date.now()
            });

            imageCardIds.push(card.id);  // âœ… è®°å½•å¡ç‰ŒID
            totalSize += blob.size;

            // æ›´æ–°å¡ç‰Œçš„ imageUrl
            updatedCards.push({
              ...card,
              imageUrl: generateDbUrl(card.id)  // "db://cardId"
            });
          } else {
            updatedCards.push(card);
          }
        }

        // æ‰¹é‡å†™å…¥å›¾ç‰‡åˆ° IndexedDB
        await db.images.bulkPut(imageRecords);

        return {
          importedCount: imageRecords.length,
          totalSize: totalSize,
          updatedCards: updatedCards,
          imageCardIds: imageCardIds  // âœ… è¿”å›å›¾ç‰‡IDåˆ—è¡¨
        };
      }
    );

    return {
      success: true,
      batchId: batchId,
      ...result
    };

  } catch (error) {
    console.error('[importBatchImages] Transaction failed:', error);
    return {
      success: false,
      batchId: batchId,
      importedCount: 0,
      totalSize: 0,
      updatedCards: cards,
      imageCardIds: [],  // âœ… ç©ºåˆ—è¡¨
      errors: [error instanceof Error ? error.message : String(error)]
    };
  }
}
```

**å…³é”®å˜åŒ–**:
- âœ… é”®æ ¼å¼ä» `batchId/cardId` æ”¹ä¸º `cardId`
- âœ… è¿”å› `imageCardIds` åˆ—è¡¨ï¼ˆç”¨äºåç»­åˆ é™¤ï¼‰
- âœ… ä¸å†éœ€è¦ `batchRegistry` è¡¨

### 2. æ‰¹æ¬¡çº§åˆ é™¤

**å‡½æ•°**: `deleteBatchImages(imageCardIds: string[])`
**ä½ç½®**: `card/stores/image-service/image-manager.ts`

```typescript
/**
 * åˆ é™¤æ‰¹æ¬¡å›¾ç‰‡
 * æ³¨æ„: imageCardIds ä»æ‰¹æ¬¡å…ƒä¿¡æ¯ï¼ˆlocalStorageï¼‰ä¸­è·å–
 *
 * @param imageCardIds æœ‰å›¾ç‰‡çš„å¡ç‰ŒIDåˆ—è¡¨
 */
export async function deleteBatchImages(imageCardIds: string[]): Promise<void> {
  if (imageCardIds.length === 0) {
    console.log('[deleteBatchImages] No images to delete');
    return;
  }

  const db = getCardImageDB();

  try {
    // ç›´æ¥æ‰¹é‡åˆ é™¤å›¾ç‰‡
    await db.images.bulkDelete(imageCardIds);

    console.log(`[deleteBatchImages] Deleted ${imageCardIds.length} images`);

  } catch (error) {
    console.error('[deleteBatchImages] Failed:', error);
    throw error;
  }
}
```

**å…³é”®å˜åŒ–**:
- âœ… å‚æ•°ä» `batchId` æ”¹ä¸º `imageCardIds` åˆ—è¡¨
- âœ… ä¸å†éœ€è¦æŸ¥è¯¢ `batchRegistry`
- âœ… ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ ID åˆ—è¡¨åˆ é™¤
- âœ… å›¾ç‰‡IDåˆ—è¡¨ä» localStorage çš„æ‰¹æ¬¡å…ƒä¿¡æ¯ä¸­è·å–

---

## å¯¼å…¥å¯¼å‡ºæµç¨‹

### ZIPæ–‡ä»¶æ ¼å¼è§„èŒƒ

çœŸå®å¡åŒ…ä½¿ç”¨ZIPæ ¼å¼è¿›è¡Œåˆ†å‘ï¼Œæ ‡å‡†ç»“æ„å¦‚ä¸‹ï¼š

```
mypack.zip
â”œâ”€â”€ cards.json          # å¡ç‰Œæ•°æ®ï¼ˆImportDataæ ¼å¼ï¼‰
â”œâ”€â”€ card1.webp          # å›¾ç‰‡æ–‡ä»¶ï¼ˆæ–‡ä»¶å = cardIdï¼‰
â”œâ”€â”€ card2.png
â”œâ”€â”€ card3.jpg
â””â”€â”€ ...
```

**å…³é”®è§„åˆ™**:
- âœ… `cards.json` å¿…é¡»å­˜åœ¨ï¼ˆåŒ…å«æ‰€æœ‰å¡ç‰Œæ•°æ®ï¼‰
- âœ… å›¾ç‰‡æ–‡ä»¶å = `{cardId}.{ext}`ï¼ˆæ‰©å±•åï¼šwebp/png/jpg/jpegï¼‰
- âœ… cardId å¿…é¡»ä¸ `cards.json` ä¸­çš„å¡ç‰ŒIDä¸€è‡´
- âœ… å›¾ç‰‡å¯é€‰ï¼ˆæ²¡æœ‰å›¾ç‰‡çš„å¡ç‰Œä¸å½±å“å¯¼å…¥ï¼‰

### å¡åŒ…å¯¼å…¥æµç¨‹

```typescript
/**
 * å®Œæ•´å¯¼å…¥æµç¨‹
 *
 * æ­¥éª¤:
 * 1. ç”¨æˆ·é€‰æ‹©ZIPæ–‡ä»¶
 * 2. è§£æZIPå†…å®¹ï¼ˆcards.json + å›¾ç‰‡ï¼‰
 * 3. å¯¼å…¥å¡ç‰Œæ•°æ®åˆ°Store
 * 4. å¯¼å…¥å›¾ç‰‡åˆ°IndexedDB
 * 5. ä¿å­˜æ‰¹æ¬¡å…ƒä¿¡æ¯åˆ°localStorage
 */

import { importZipCardPack } from '@/card/importers/zip-importer';
import { useUnifiedCardStore } from '@/card/stores/unified-card-store';

async function handleZipImport(file: File) {
  // æ­¥éª¤1: è§£æZIPæ–‡ä»¶
  const zipResult = await importZipCardPack(file, file.name);

  if (!zipResult.success || !zipResult.data) {
    console.error('ZIPè§£æå¤±è´¥:', zipResult.errors);
    return;
  }

  const { data: importData, images } = zipResult;

  // æ­¥éª¤2: å¯¼å…¥å¡ç‰Œæ•°æ®
  const store = useUnifiedCardStore.getState();
  const importResult = await store.importCustomCards(
    importData,
    file.name
  );

  if (!importResult.success) {
    console.error('å¡ç‰Œå¯¼å…¥å¤±è´¥');
    return;
  }

  const { batchId } = importResult;

  // æ­¥éª¤3: å¯¼å…¥å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
  if (images && images.size > 0) {
    const imageResult = await store.importBatchImages(
      batchId,
      importData.name || 'æœªå‘½åæ‰¹æ¬¡',
      images
    );

    if (!imageResult.success) {
      console.error('å›¾ç‰‡å¯¼å…¥å¤±è´¥:', imageResult.errors);
      // æ³¨æ„: å¡ç‰Œå·²å¯¼å…¥ï¼Œåªæ˜¯å›¾ç‰‡å¤±è´¥
    } else {
      console.log(
        `âœ… å¯¼å…¥æˆåŠŸ: ${imageResult.importedCount}å¼ å›¾ç‰‡, ` +
        `${(imageResult.totalSize / 1024).toFixed(2)}KB`
      );

      // æ­¥éª¤4: æ›´æ–°localStorageä¸­çš„æ‰¹æ¬¡å…ƒä¿¡æ¯
      // (store.importBatchImagesä¼šè‡ªåŠ¨å¤„ç†ï¼Œè¿™é‡Œä»…ä½œè¯´æ˜)
      // localStorageä¸­ä¼šä¿å­˜:
      // - imageCardIds: string[]  (æœ‰å›¾ç‰‡çš„å¡ç‰ŒIDåˆ—è¡¨)
    }
  }

  console.log(`âœ… å¡åŒ…å¯¼å…¥å®Œæˆ: ${importData.name}`);
}
```

**å¯¼å…¥åçš„æ•°æ®å­˜å‚¨**:

```
IndexedDB (card-images)
â”œâ”€â”€ images è¡¨
â”‚   â”œâ”€â”€ key: "pack1-author-prof-warrior"  â†’ Blob
â”‚   â”œâ”€â”€ key: "pack1-author-prof-ranger"   â†’ Blob
â”‚   â””â”€â”€ ...

localStorage
â”œâ”€â”€ daggerheart_custom_cards_index
â”‚   â””â”€â”€ ["batch_123", "batch_456", ...]
â”‚
â””â”€â”€ daggerheart_custom_cards_batch_batch_123
    â””â”€â”€ {
          id: "batch_123",
          name: "My Pack",
          cardIds: ["pack1-author-prof-warrior", "pack1-author-prof-ranger", ...],
          imageCardIds: ["pack1-author-prof-warrior"],  // âœ… æœ‰å›¾ç‰‡çš„å¡ç‰Œ
          ...
        }
```

### å¡åŒ…å¯¼å‡ºæµç¨‹

```typescript
/**
 * å®Œæ•´å¯¼å‡ºæµç¨‹
 *
 * æ­¥éª¤:
 * 1. ä»Storeè·å–æ‰¹æ¬¡æ•°æ®
 * 2. ä»IndexedDBè¯»å–å›¾ç‰‡
 * 3. ç”Ÿæˆcards.json
 * 4. æ‰“åŒ…ZIPæ–‡ä»¶
 * 5. è§¦å‘æµè§ˆå™¨ä¸‹è½½
 */

import { exportAndDownloadBatch } from '@/card/exporters/zip-exporter';

async function handleBatchExport(batchId: string) {
  // ä¸€é”®å¯¼å‡ºå¹¶ä¸‹è½½
  const result = await exportAndDownloadBatch(batchId);

  if (result.success) {
    console.log('âœ… å¯¼å‡ºæˆåŠŸ');
  } else {
    console.error('å¯¼å‡ºå¤±è´¥:', result.errors);
  }
}
```

**è¯¦ç»†å¯¼å‡ºæ­¥éª¤**:

```typescript
import JSZip from 'jszip';
import { useUnifiedCardStore } from '@/card/stores/unified-card-store';
import { getImage } from '@/card/stores/image-service';

async function exportBatchDetailed(batchId: string) {
  const store = useUnifiedCardStore.getState();
  const batch = store.batches.get(batchId);

  if (!batch) {
    throw new Error(`æ‰¹æ¬¡ä¸å­˜åœ¨: ${batchId}`);
  }

  // æ­¥éª¤1: å‡†å¤‡å¡ç‰Œæ•°æ®
  const cards = batch.cardIds
    .map((id: string) => store.cards.get(id))
    .filter((card) => card !== undefined);

  // æ­¥éª¤2: ç”ŸæˆImportDataæ ¼å¼çš„JSON
  const importData = {
    name: batch.name,
    version: batch.version,
    description: batch.description,
    author: batch.author,
    profession: cards.filter(c => c.type === 'profession'),
    ancestry: cards.filter(c => c.type === 'ancestry'),
    // ... å…¶ä»–ç±»å‹
  };

  // æ­¥éª¤3: åˆ›å»ºZIP
  const zip = new JSZip();
  zip.file('cards.json', JSON.stringify(importData, null, 2));

  // æ­¥éª¤4: æ·»åŠ å›¾ç‰‡
  for (const card of cards) {
    if (card.imageUrl?.startsWith('db://')) {
      const cardId = card.imageUrl.substring(5);

      // ä»IndexedDBè¯»å–å›¾ç‰‡ï¼ˆä½¿ç”¨cardIdä½œä¸ºé”®ï¼‰
      const blob = await getImage(cardId);

      if (blob) {
        const ext = blob.type === 'image/png' ? 'png' :
                   blob.type === 'image/jpeg' ? 'jpg' : 'webp';

        // æ–‡ä»¶å = cardId.ext
        zip.file(`${card.id}.${ext}`, blob);
      }
    }
  }

  // æ­¥éª¤5: ç”ŸæˆZIPæ–‡ä»¶
  const zipBlob = await zip.generateAsync({
    type: 'blob',
    compression: 'DEFLATE',
    compressionOptions: { level: 6 }
  });

  // æ­¥éª¤6: ä¸‹è½½
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${batch.name}-${Date.now()}.zip`;
  a.click();
  URL.revokeObjectURL(url);
}
```

### å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ZIP å¯¼å…¥æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  User selects ZIP file
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ zip-importer.ts â”‚ - è§£æZIP
  â”‚                 â”‚ - æå– cards.json
  â”‚                 â”‚ - æå–å›¾ç‰‡æ–‡ä»¶
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Store Actions   â”‚ - importCustomCards()
  â”‚                 â”‚   (ä¿å­˜å¡ç‰Œæ•°æ®)
  â”‚                 â”‚
  â”‚                 â”‚ - importBatchImages()
  â”‚                 â”‚   (ä¿å­˜å›¾ç‰‡åˆ°IndexedDB)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ æŒä¹…åŒ–å­˜å‚¨                             â”‚
  â”‚                                       â”‚
  â”‚ IndexedDB (card-images)               â”‚
  â”‚ â”œâ”€â”€ images è¡¨                         â”‚
  â”‚ â”‚   â”œâ”€â”€ key: cardId â†’ Blob            â”‚
  â”‚ â”‚   â””â”€â”€ ...                           â”‚
  â”‚                                       â”‚
  â”‚ localStorage                          â”‚
  â”‚ â”œâ”€â”€ batch index                       â”‚
  â”‚ â””â”€â”€ batch_xxx                         â”‚
  â”‚     â”œâ”€â”€ cardIds                       â”‚
  â”‚     â””â”€â”€ imageCardIds  â† æ–°å¢å­—æ®µ     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ZIP å¯¼å‡ºæµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  User clicks export
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Store Actions   â”‚ - è¯»å–æ‰¹æ¬¡æ•°æ®
  â”‚                 â”‚ - è¯»å–å¡ç‰Œåˆ—è¡¨
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Image Service   â”‚ - getImage(cardId)
  â”‚                 â”‚ - ä» IndexedDB è¯»å–å›¾ç‰‡
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ zip-exporter.ts â”‚ - ç”Ÿæˆ cards.json
  â”‚                 â”‚ - æ‰“åŒ…å›¾ç‰‡
  â”‚                 â”‚ - åˆ›å»ºZIPæ–‡ä»¶
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
  Browser downloads ZIP file
```

### å…³é”®è®¾è®¡ç‚¹

#### 1. cardId ä½œä¸ºå›¾ç‰‡æ–‡ä»¶å

**ä¸ºä»€ä¹ˆä½¿ç”¨ cardId**:
- âœ… cardId æ˜¯å…¨å±€å”¯ä¸€çš„ï¼ˆåŒ…å« packageName + authorï¼‰
- âœ… å¯¼å…¥æ—¶å¯ä»¥ç›´æ¥åŒ¹é…å¡ç‰Œå’Œå›¾ç‰‡
- âœ… æ— éœ€é¢å¤–çš„æ˜ å°„å…³ç³»

**ç¤ºä¾‹**:
```
å¡ç‰ŒID: "mypack-john-prof-warrior"
å›¾ç‰‡æ–‡ä»¶å: "mypack-john-prof-warrior.webp"
IndexedDBé”®: "mypack-john-prof-warrior"
```

#### 2. imageCardIds åˆ—è¡¨

**ç”¨é€”**: åˆ é™¤æ‰¹æ¬¡æ—¶å¿«é€Ÿå®šä½éœ€è¦åˆ é™¤çš„å›¾ç‰‡

**å·¥ä½œæµç¨‹**:
1. å¯¼å…¥æ—¶è®°å½•: `importBatchImages()` è¿”å› `imageCardIds`
2. ä¿å­˜åˆ°localStorage: æ‰¹æ¬¡å…ƒä¿¡æ¯ä¸­
3. åˆ é™¤æ—¶ä½¿ç”¨: ä»localStorageè¯»å–ï¼Œä¼ é€’ç»™ `deleteBatchImages(imageCardIds)`

#### 3. åŸå­æ€§ä¿è¯

**å¯¼å…¥**:
- ä½¿ç”¨ Dexie äº‹åŠ¡ç¡®ä¿å›¾ç‰‡æ‰¹é‡å†™å…¥çš„åŸå­æ€§
- å¦‚æœéƒ¨åˆ†å¤±è´¥ï¼Œæ•´ä¸ªæ‰¹æ¬¡å›æ»š

**å¯¼å‡º**:
- å›¾ç‰‡è¯»å–å¤±è´¥ä¸ä¸­æ–­æµç¨‹
- è®°å½•é”™è¯¯ä½†ç»§ç»­æ‰“åŒ…å…¶ä»–å›¾ç‰‡

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: ç¼–è¾‘å™¨ä¸Šä¼ å›¾ç‰‡

```typescript
// å¡ç‰Œç¼–è¾‘å™¨å†…éƒ¨
async function uploadImage(cardId: string, file: File) {
  const db = getCardImageDB();
  const blob = new Blob([await file.arrayBuffer()], { type: file.type });

  // ç›´æ¥å­˜å…¥ç¼–è¾‘å™¨è¡¨
  await db.editorImages.put({
    key: cardId,
    blob: blob,
    mimeType: file.type,
    size: file.size,
    createdAt: Date.now()
  });

  // æ›´æ–°å¡ç‰Œæ•°æ®
  card.imageUrl = `db://${cardId}`;
}
```

### åœºæ™¯2: å¯¼å…¥çœŸå®å¡åŒ…

```typescript
// å¡åŒ…ç®¡ç†å™¨å¯¼å…¥
const result = await store.importBatchImages(
  'official_core',           // batchId
  'Official Core Cards',     // batchName
  images
);

// å¯¼å…¥æˆåŠŸå:
if (result.success) {
  // 1. æ‰€æœ‰å¡ç‰Œ:
  //    - card.batchId = 'official_core'
  //    - card.imageUrl = 'db://cardId'
  //    - å›¾ç‰‡å­˜å‚¨é”® = 'cardId' (ç›´æ¥ä½¿ç”¨å¡ç‰ŒID)

  // 2. ä¿å­˜å›¾ç‰‡IDåˆ—è¡¨åˆ° localStorage
  const batchInfo = store.batches.get('official_core');
  const updatedBatchInfo = {
    ...batchInfo,
    imageCardIds: result.imageCardIds  // ['card1', 'card2', ...]
  };

  localStorage.setItem(
    'daggerheart_custom_cards_batch_official_core',
    JSON.stringify(updatedBatchInfo)
  );
}
```

### åœºæ™¯3: é¢„è§ˆå¡ç‰Œï¼ˆè‡ªåŠ¨åˆ†æµï¼‰

```typescript
// ä»»ä½•é¢„è§ˆç»„ä»¶
function CardPreview({ card }: { card: StandardCard }) {
  const [imageUrl, setImageUrl] = useState<string>('');

  useEffect(() => {
    async function loadImage() {
      // è‡ªåŠ¨åˆ¤æ–­æ˜¯ç¼–è¾‘å™¨è¿˜æ˜¯çœŸå®å¡åŒ…
      const url = await getCardImageUrlAsync(card);
      setImageUrl(url);
    }

    loadImage();
  }, [card]);

  return <img src={imageUrl} alt={card.name} />;
}
```

### åœºæ™¯4: åˆ é™¤å¡åŒ…

```typescript
// æ‰¹æ¬¡çº§åˆ é™¤
async function deleteBatch(batchId: string) {
  // 1. ä» localStorage è¯»å–æ‰¹æ¬¡å…ƒä¿¡æ¯
  const batchInfo = JSON.parse(
    localStorage.getItem(`daggerheart_custom_cards_batch_${batchId}`) || '{}'
  );

  if (!batchInfo.imageCardIds || batchInfo.imageCardIds.length === 0) {
    console.log('[deleteBatch] No images to delete');
    return;
  }

  // 2. åˆ é™¤ IndexedDB ä¸­çš„å›¾ç‰‡
  await store.deleteBatchImages(batchInfo.imageCardIds);

  // 3. æ¸…ç†ç¼“å­˜
  store.clearBatchImageCache(batchId);

  // 4. åˆ é™¤æ‰¹æ¬¡å…ƒä¿¡æ¯
  localStorage.removeItem(`daggerheart_custom_cards_batch_${batchId}`);
}
```

**å…³é”®ç‚¹**:
- âœ… `imageCardIds` ä» localStorage çš„æ‰¹æ¬¡å…ƒä¿¡æ¯è·å–
- âœ… ç›´æ¥ä¼ é€’ ID åˆ—è¡¨ï¼Œæ— éœ€æŸ¥è¯¢ `batchRegistry`
- âœ… åˆ é™¤é¡ºåº: IndexedDB â†’ ç¼“å­˜ â†’ localStorage

---

## è®¾è®¡ä¼˜åŠ¿

### 1. å®Œå…¨éš”ç¦»

| ç‰¹æ€§ | ç¼–è¾‘å™¨ | çœŸå®å¡åŒ… |
|------|--------|---------|
| è¡¨ | `editorImages` | `images` |
| é”®æ ¼å¼ | `cardId` | `cardId` |
| è¯»å–å‡½æ•° | `getImageUrlFromDB()` | `store.getImageUrl()` |
| ç¼“å­˜ | æ— éœ€ç¼“å­˜ | å¸¦ LRU ç¼“å­˜ |
| æ‰¹æ¬¡ç®¡ç† | ä¸éœ€è¦ | localStorage å…ƒä¿¡æ¯ |

### 2. è‡ªåŠ¨åˆ†æµ

- âœ… æ ¹æ® `card.batchId` è‡ªåŠ¨åˆ¤æ–­ç±»å‹
- âœ… æ— éœ€æ‰‹åŠ¨æŒ‡å®šè¯»å–æ–¹å¼
- âœ… é¢„è§ˆç»„ä»¶ç»Ÿä¸€ä½¿ç”¨ `getCardImageUrlAsync()`

### 3. ç±»å‹å®‰å…¨

```typescript
// çœŸå®å¡åŒ…å¿…é¡»æœ‰ batchId
if (!card.batchId) {
  console.warn('ç¼–è¾‘å™¨å¡ç‰Œä¸åº”è°ƒç”¨ store.getImageUrl()');
  return null;
}
```

### 4. åŸå­æ“ä½œ

- âœ… æ‰¹æ¬¡å¯¼å…¥ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- âœ… æ‰¹æ¬¡åˆ é™¤ï¼šä¸€æ¬¡æ€§åˆ é™¤æ‰€æœ‰ç›¸å…³å›¾ç‰‡
- âœ… æ— å­¤å„¿å›¾ç‰‡ï¼šé€šè¿‡ localStorage å…ƒä¿¡æ¯è¿½è¸ª

### 5. ç®€åŒ–æ¶æ„

- âœ… æ— éœ€ `batchId` å‰ç¼€ï¼šcardId è‡ªå¸¦å…¨å±€å”¯ä¸€æ€§ï¼ˆåŒ…å« packageName + authorï¼‰
- âœ… æ— éœ€ `batchRegistry` è¡¨ï¼šå…ƒä¿¡æ¯å­˜å‚¨åœ¨ localStorage
- âœ… åˆ é™¤æ“ä½œç®€åŒ–ï¼šç›´æ¥ä½¿ç”¨ ID åˆ—è¡¨ï¼Œæ— éœ€æŸ¥è¯¢

---

## æ³¨æ„äº‹é¡¹

### âš ï¸ å¸¸è§é”™è¯¯

**é”™è¯¯1: ç¼–è¾‘å™¨å¡ç‰Œè°ƒç”¨çœŸå®å¡åŒ…æ¥å£**
```typescript
// âŒ é”™è¯¯
const editorCard = { id: 'test', imageUrl: 'db://test' }; // æ—  batchId
await store.getImageUrl('test');  // ä¼šæŠ¥è­¦å‘Šå¹¶è¿”å› null

// âœ… æ­£ç¡®
await getImageUrlFromDB('test');
```

**é”™è¯¯2: ä½¿ç”¨ `batchId` ä½œä¸ºé”®å‰ç¼€**
```typescript
// âŒ é”™è¯¯: è¿‡å»çš„è®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰
const key = generateImageKey(card.batchId, cardId);  // "batchId/cardId"

// âœ… æ­£ç¡®: å½“å‰ç®€åŒ–è®¾è®¡
const key = cardId;  // ç›´æ¥ä½¿ç”¨ cardIdï¼ˆå·²åŒ…å«å…¨å±€å”¯ä¸€æ€§ï¼‰
```

**é”™è¯¯3: æ··ç”¨ä¸¤ç§è¯»å–æ–¹å¼**
```typescript
// âŒ é”™è¯¯: ä¸è¦å°è¯•ä»ä¸¤ä¸ªè¡¨æŸ¥æ‰¾
const editorImage = await db.editorImages.get(cardId);
if (!editorImage) {
  const realImage = await db.images.get(cardId);  // æ²¡æœ‰ batchId åˆ¤æ–­ï¼
}

// âœ… æ­£ç¡®: æ ¹æ® batchId åˆ¤æ–­ä½¿ç”¨å“ªä¸ªè¡¨
if (card.batchId) {
  // çœŸå®å¡åŒ…
  const realImage = await db.images.get(cardId);
} else {
  // ç¼–è¾‘å™¨
  const editorImage = await db.editorImages.get(cardId);
}
```

### ğŸ“ æœ€ä½³å®è·µ

1. **ç¼–è¾‘å™¨ä»£ç **: å§‹ç»ˆä½¿ç”¨ `getImageUrlFromDB(cardId)`
2. **çœŸå®å¡åŒ…ä»£ç **: å§‹ç»ˆä½¿ç”¨ `store.getImageUrl(cardId)`
3. **é€šç”¨é¢„è§ˆä»£ç **: ä½¿ç”¨ `getCardImageUrlAsync(card)` è‡ªåŠ¨åˆ†æµ
4. **é”®æ ¼å¼**: çœŸå®å¡åŒ…å’Œç¼–è¾‘å™¨éƒ½ç›´æ¥ä½¿ç”¨ `cardId` ä½œä¸ºé”®
5. **æ‰¹æ¬¡åˆ é™¤**: ä» localStorage æ‰¹æ¬¡å…ƒä¿¡æ¯è·å– `imageCardIds`ï¼Œç›´æ¥ä¼ é€’ç»™åˆ é™¤å‡½æ•°

---

## ç›¸å…³æ–‡ä»¶

- `card/stores/image-service/database.ts` - æ•°æ®åº“å®šä¹‰
- `card/stores/image-service/image-manager.ts` - æ‰¹æ¬¡çº§æ“ä½œ
- `card/stores/image-service-actions.ts` - Store actions
- `app/card-editor/utils/image-db-helpers.ts` - ç¼–è¾‘å™¨å¸®åŠ©å‡½æ•°
- `lib/utils.ts` - é€šç”¨é¢„è§ˆå±‚
- `docs/å¡ç‰Œå›¾ç‰‡IndexedDBå­˜å‚¨æ¶æ„.md` - ç¼–è¾‘å™¨æ¶æ„æ–‡æ¡£

---

## æ›´æ–°æ—¥å¿—

- **2025-01-02** - åˆå§‹ç‰ˆæœ¬
  - å®šä¹‰ç¼–è¾‘å™¨å’ŒçœŸå®å¡åŒ…çš„å®Œå…¨åˆ†ç¦»æ¶æ„
  - åŸºäº `batchId` çš„è‡ªåŠ¨åˆ†æµç­–ç•¥
  - æ‰¹æ¬¡çº§åŸå­æ“ä½œè®¾è®¡
- **2025-01-02** - ç®€åŒ–æ¶æ„æ›´æ–°
  - ç§»é™¤ `batchId` é”®å‰ç¼€ï¼Œç›´æ¥ä½¿ç”¨ `cardId`ï¼ˆåˆ©ç”¨ cardId çš„å…¨å±€å”¯ä¸€æ€§ï¼‰
  - ç§»é™¤ `batchRegistry` è¡¨ï¼Œä½¿ç”¨ localStorage æ‰¹æ¬¡å…ƒä¿¡æ¯
  - ç®€åŒ–åˆ é™¤æ“ä½œï¼šç›´æ¥ä½¿ç”¨ `imageCardIds` åˆ—è¡¨
  - æ›´æ–°æ‰€æœ‰ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

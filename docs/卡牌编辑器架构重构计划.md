# å¡ç‰Œç¼–è¾‘å™¨æ¶æ„é‡æ„è®¡åˆ’

## é‡æ„ç›®æ ‡

### ç°æœ‰é—®é¢˜
1. **IDç”Ÿæˆé—®é¢˜**ï¼šä¿®æ”¹å¡åŒ…åç§°åï¼Œå¡ç‰ŒIDä¸ä¼šè‡ªåŠ¨æ›´æ–°
2. **æ•°æ®æµæ··ä¹±**ï¼š4å±‚æ•°æ®ä¼ é€’ï¼Œå¤šä¸ªé»˜è®¤å€¼å®šä¹‰ï¼Œå®¹æ˜“å‡ºç°æ•°æ®ä¸ä¸€è‡´
3. **é¡µé¢åˆ‡æ¢é—®é¢˜**ï¼šåˆ‡æ¢é¡µé¢åå¡åŒ…åç§°æ˜¾ç¤ºä¸º"æ–°å»ºå¡åŒ…"
4. **ç»´æŠ¤å›°éš¾**ï¼šç›¸åŒçš„IDç”Ÿæˆé€»è¾‘æ•£å¸ƒåœ¨å¤šä¸ªç»„ä»¶ä¸­

### é‡æ„åŸç†
**æ ¸å¿ƒæ´å¯Ÿ**ï¼šæˆ‘ä»¬åªæ˜¯åœ¨ç¼–è¾‘ä¸€ä¸ªJSONæ–‡ä»¶ï¼Œç†æƒ³çš„æ¶æ„åº”è¯¥æ˜¯ï¼š
```
JSONæ•°æ® â† â†’ Store â† â†’ UI
```

### ç›®æ ‡æ¶æ„
- **JSONæ˜¯å”¯ä¸€çœŸå®æ•°æ®æº**
- **Storeåªæ˜¯JSONçš„æ“ä½œå±‚**
- **UIåªæ˜¯JSONçš„å±•ç¤ºå±‚**
- **ä»»ä½•ä¿®æ”¹éƒ½ç›´æ¥ä¿®æ”¹JSONï¼Œå…¶ä»–ä¸€åˆ‡è‡ªåŠ¨åŒæ­¥**

## é‡æ„è®¡åˆ’ï¼ˆ6ä¸ªæ­¥éª¤ï¼‰

### æ­¥éª¤1ï¼šStoreå±‚é‡æ„ - é›†ä¸­æ•°æ®æ“ä½œ âœ… å·²å®Œæˆ
**ç›®æ ‡**ï¼šå°†æ‰€æœ‰æ•°æ®æ“ä½œé›†ä¸­åˆ°storeï¼Œå®ç°è‡ªåŠ¨IDç®¡ç†

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- `app/card-editor/store/card-editor-store.ts` âœ…

#### å…·ä½“ä¿®æ”¹ï¼š
1. **å¢å¼ºupdateCardæ–¹æ³•**ï¼š
```typescript
// é‡æ„å‰
updateCard: (type, index, card) =>
  set(state => ({
    packageData: {
      ...state.packageData,
      [type]: state.packageData[type].map((c, i) => i === index ? card : c)
    }
  }))

// é‡æ„å
updateCard: (type, index, updates) =>
  set(state => {
    const newCard = { ...state.packageData[type][index], ...updates }

    // è‡ªåŠ¨å¤„ç†IDç”Ÿæˆ
    if (updates.åç§°) {
      newCard.id = generateSmartCardId(
        state.packageData.name || 'æ–°å»ºå¡åŒ…',
        state.packageData.author || 'æœªçŸ¥ä½œè€…',
        type,
        updates.åç§°,
        state.packageData
      )
    }

    return {
      packageData: {
        ...state.packageData,
        [type]: state.packageData[type].map((c, i) => i === index ? newCard : c)
      }
    }
  })
```

2. **å¢å¼ºupdateMetadataæ–¹æ³•**ï¼š
```typescript
// é‡æ„å - åŒ…å/ä½œè€…å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¡ç‰ŒID
updateMetadata: (field, value) =>
  set(state => {
    const newPackageData = { ...state.packageData, [field]: value }

    // å¦‚æœä¿®æ”¹çš„æ˜¯åŒ…åæˆ–ä½œè€…ï¼Œé‡æ–°ç”Ÿæˆæ‰€æœ‰å¡ç‰ŒID
    if (field === 'name' || field === 'author') {
      const cardTypes: CardType[] = ['profession', 'ancestry', 'community', 'subclass', 'domain', 'variant']

      cardTypes.forEach(cardType => {
        if (newPackageData[cardType] && Array.isArray(newPackageData[cardType])) {
          newPackageData[cardType] = newPackageData[cardType].map(card => ({
            ...card,
            id: generateSmartCardId(
              newPackageData.name || 'æ–°å»ºå¡åŒ…',
              newPackageData.author || 'æœªçŸ¥ä½œè€…',
              cardType,
              card.åç§° || 'æœªå‘½å',
              newPackageData
            )
          }))
        }
      })
    }

    return { packageData: newPackageData }
  })
```

#### å®é™…ä¿®æ”¹å†…å®¹ï¼š
1. **æ·»åŠ äº†generateSmartCardIdå¯¼å…¥**
2. **é‡æ„äº†updateCardæ–¹æ³•**ï¼š
   - å‚æ•°ä»`card`æ”¹ä¸º`updates`ï¼ˆæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼‰
   - æ·»åŠ è‡ªåŠ¨IDç”Ÿæˆé€»è¾‘ï¼Œå½“åç§°å˜åŒ–æ—¶é‡æ–°ç”ŸæˆID
   - å¢åŠ è¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢è®¿é—®ä¸å­˜åœ¨çš„å¡ç‰Œ

3. **é‡æ„äº†updateMetadataæ–¹æ³•**ï¼š
   - å½“åŒ…åæˆ–ä½œè€…å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¡ç‰Œçš„ID
   - éå†æ‰€æœ‰å¡ç‰Œç±»å‹ï¼Œç¡®ä¿IDä¸€è‡´æ€§

#### æµ‹è¯•éªŒè¯ ğŸ” éœ€è¦éªŒè¯ï¼š
- [ ] ä¿®æ”¹å¡åŒ…åç§°ï¼ŒéªŒè¯æ‰€æœ‰å¡ç‰ŒIDæ˜¯å¦è‡ªåŠ¨æ›´æ–°
- [ ] ä¿®æ”¹ä½œè€…åç§°ï¼ŒéªŒè¯æ‰€æœ‰å¡ç‰ŒIDæ˜¯å¦è‡ªåŠ¨æ›´æ–°
- [ ] ä¿®æ”¹å¡ç‰Œåç§°ï¼ŒéªŒè¯è¯¥å¡ç‰ŒIDæ˜¯å¦è‡ªåŠ¨æ›´æ–°
- [ ] ç¡®ä¿å…¶ä»–å¡ç‰ŒåŠŸèƒ½ï¼ˆæ·»åŠ ã€åˆ é™¤ã€å¤åˆ¶ï¼‰ä»æ­£å¸¸å·¥ä½œ

---

### æ­¥éª¤2ï¼šç§»é™¤è¡¨å•ç»„ä»¶çš„IDç”Ÿæˆé€»è¾‘ âœ… å·²å®Œæˆ
**ç›®æ ‡**ï¼šæ¸…ç†è¡¨å•ç»„ä»¶ï¼Œç§»é™¤é‡å¤çš„IDç”Ÿæˆä»£ç 

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- `components/card-editor/card-form.tsx` âœ…
- `components/card-editor/ancestry-dual-card-form.tsx` âœ… (å·²æœ‰æ­£ç¡®çš„onBlur)
- `components/card-editor/subclass-triple-card-form.tsx` âœ… (å·²æœ‰æ­£ç¡®çš„onBlur)

#### å…·ä½“ä¿®æ”¹ï¼š
1. **ç§»é™¤æ‰€æœ‰IDç›¸å…³çš„useEffect**ï¼š
```typescript
// åˆ é™¤ä»¥ä¸‹ä»£ç å—
// ç›‘å¬åç§°å­—æ®µå˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°ID (ç¬¬105-122è¡Œ)
// åˆå§‹åŒ–æ—¶å¦‚æœæ²¡æœ‰IDæˆ–IDä¸ºé»˜è®¤å€¼ï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆ (ç¬¬125-139è¡Œ)
```

2. **ç§»é™¤IDç›¸å…³çš„stateå’Œå‡½æ•°**ï¼š
```typescript
// åˆ é™¤
const [isEditingId, setIsEditingId] = useState(false)
const [autoGenerateId, setAutoGenerateId] = useState(true)
const generateId = () => { ... }
```

3. **ç§»é™¤IDç¼–è¾‘UI**ï¼š
```typescript
// åˆ é™¤èŒä¸šåç§°å­—æ®µä¸­çš„IDæ˜¾ç¤ºå’Œç¼–è¾‘éƒ¨åˆ† (ç¬¬190-258è¡Œ)
```

4. **ç®€åŒ–handleFieldBlur**ï¼š
```typescript
// é‡æ„å‰
const handleFieldBlur = () => {
  setTimeout(() => {
    handleAutoSave()
  }, 100)
}

// é‡æ„å - ç›´æ¥è°ƒç”¨
const handleFieldBlur = () => {
  handleAutoSave()
}
```

#### å®é™…ä¿®æ”¹å†…å®¹ï¼š
1. **å®Œå…¨é‡å†™äº†card-form.tsx**ï¼š
   - ç§»é™¤æ‰€æœ‰IDç”Ÿæˆç›¸å…³çš„stateï¼š`isEditingId`, `autoGenerateId`
   - ç§»é™¤æ‰€æœ‰IDç”Ÿæˆç›¸å…³çš„useEffectï¼ˆåç§°ç›‘å¬ã€åˆå§‹åŒ–ç”Ÿæˆï¼‰
   - ç§»é™¤IDç¼–è¾‘UIç•Œé¢ï¼ˆIDæ˜¾ç¤ºã€ç¼–è¾‘æŒ‰é’®ã€è‡ªåŠ¨ç”Ÿæˆåˆ‡æ¢ï¼‰
   - ç§»é™¤æ‰‹åŠ¨ç”ŸæˆIDå‡½æ•°
   - ç®€åŒ–handleFieldBlurï¼Œå»æ‰setTimeoutåŒ…è£…
   - ä¿ç•™äº†èŒä¸šç®€ä»‹çš„éå¿…å¡«ä¿®æ”¹

2. **å¤‡ä»½åŸæ–‡ä»¶**ï¼š
   - åŸæ–‡ä»¶å·²å¤‡ä»½ä¸º `card-form-backup.tsx`
   - æ–°æ–‡ä»¶å¤§å¹…ç®€åŒ–ï¼Œåªä¿ç•™æ ¸å¿ƒè¡¨å•åŠŸèƒ½

3. **å…¶ä»–è¡¨å•æ–‡ä»¶**ï¼š
   - `ancestry-dual-card-form.tsx` å’Œ `subclass-triple-card-form.tsx` å·²åœ¨æ­¥éª¤1ä¸­æ­£ç¡®æ·»åŠ onBlurï¼Œæ— éœ€ä¿®æ”¹

#### æµ‹è¯•éªŒè¯ ğŸ” éœ€è¦éªŒè¯ï¼š
- [ ] èŒä¸šå¡è¡¨å•èƒ½æ­£å¸¸æ˜¾ç¤ºå’Œç¼–è¾‘
- [ ] è¡¨å•æ•°æ®ä¿®æ”¹èƒ½æ­£ç¡®ä¿å­˜åˆ°storeï¼ˆé€šè¿‡onSaveï¼‰
- [ ] KeywordComboboxçš„onBlurè§¦å‘æ­£å¸¸å·¥ä½œ
- [ ] å…¶ä»–å¡ç‰Œç±»å‹ï¼ˆç§æ—ã€å˜ä½“ç­‰ï¼‰æš‚æ—¶æ˜¾ç¤ºå ä½ç¬¦ä½†ä¸å½±å“åŠŸèƒ½
- [ ] IDç”Ÿæˆç°åœ¨å®Œå…¨ç”±storeè‡ªåŠ¨å¤„ç†

---

### æ­¥éª¤3ï¼šç®€åŒ–ç»„ä»¶propsä¼ é€’
**ç›®æ ‡**ï¼šç§»é™¤packageInfo propsï¼Œç»„ä»¶ç›´æ¥ä»storeè·å–æ•°æ®

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- `app/card-editor/components/card-tabs/card-editor-tab.tsx`
- `components/card-editor/card-form.tsx`

#### card-editor-tab.tsxä¿®æ”¹ï¼š
```typescript
// é‡æ„å‰
const commonProps = {
  card: currentCard,
  onSave: (updatedCard: unknown) => onUpdateCard(cardType, safeIndex, updatedCard),
  onChange: handleFormChange,
  keywordLists: currentPackage.customFieldDefinitions,
  onAddKeyword: handleAddKeyword,
  packageInfo: {
    name: currentPackage.name || 'æœªå‘½åå¡åŒ…',
    author: currentPackage.author || 'æœªçŸ¥ä½œè€…'
  }
}

// é‡æ„å - ç§»é™¤packageInfo
const commonProps = {
  card: currentCard,
  cardIndex: safeIndex,
  cardType: cardType,
  keywordLists: currentPackage.customFieldDefinitions,
  onAddKeyword: handleAddKeyword,
}
```

#### card-form.tsxä¿®æ”¹ï¼š
```typescript
// é‡æ„å‰
export function ProfessionCardForm({
  card,
  onSave,
  onChange,
  keywordLists,
  onAddKeyword,
  packageInfo,    // åˆ é™¤
  packageData     // åˆ é™¤
}: BaseCardFormProps<ProfessionCard>) {

// é‡æ„å
export function ProfessionCardForm({
  card,
  cardIndex,
  cardType,
  keywordLists,
  onAddKeyword
}: BaseCardFormProps<ProfessionCard>) {
  const { updateCard } = useCardEditorStore()  // ç›´æ¥ä½¿ç”¨store
```

#### æµ‹è¯•éªŒè¯ï¼š
- ç»„ä»¶èƒ½æ­£ç¡®æ¸²æŸ“
- æ•°æ®ä¿®æ”¹èƒ½æ­£ç¡®ä¿å­˜åˆ°store

---

### æ­¥éª¤4ï¼šé‡æ„è¡¨å•æ•°æ®æµ
**ç›®æ ‡**ï¼šè¡¨å•ç›´æ¥ä¸storeäº¤äº’ï¼Œç§»é™¤ä¸­é—´å±‚

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- `components/card-editor/card-form.tsx`ï¼ˆæ‰€æœ‰è¡¨å•ç»„ä»¶ï¼‰

#### å…·ä½“ä¿®æ”¹ï¼š
```typescript
// é‡æ„å‰ - é€šè¿‡propså±‚å±‚ä¼ é€’
const handleAutoSave = () => {
  const currentData = form.getValues()
  onSave(currentData)  // é€šè¿‡propsè°ƒç”¨
}

// é‡æ„å - ç›´æ¥è°ƒç”¨store
const handleAutoSave = () => {
  const currentData = form.getValues()
  updateCard(cardType, cardIndex, currentData)  // ç›´æ¥è°ƒç”¨store
}
```

```typescript
// é‡æ„å‰ - å¤æ‚çš„onChangeå¤„ç†
useEffect(() => {
  if (!onChange) return
  const subscription = form.watch((value) => {
    onChange(value as ProfessionCard)
  })
  return () => subscription.unsubscribe()
}, [form, onChange])

// é‡æ„å - ç®€å•çš„å®æ—¶ä¿å­˜
useEffect(() => {
  const subscription = form.watch((value) => {
    updateCard(cardType, cardIndex, value)
  })
  return () => subscription.unsubscribe()
}, [form, cardType, cardIndex, updateCard])
```

#### æµ‹è¯•éªŒè¯ï¼š
- è¡¨å•å®æ—¶ä¿å­˜åŠŸèƒ½æ­£å¸¸
- æ•°æ®å˜åŒ–ç«‹å³åæ˜ åœ¨å…¶ä»–ç»„ä»¶ä¸­

---

### æ­¥éª¤5ï¼šæ¸…ç†å†—ä½™ä»£ç å’Œæ¥å£
**ç›®æ ‡**ï¼šåˆ é™¤ä¸å†éœ€è¦çš„ä»£ç ï¼Œç®€åŒ–ç±»å‹å®šä¹‰

#### ä¿®æ”¹æ–‡ä»¶ï¼š
- `components/card-editor/card-form.tsx`
- `app/card-editor/types/index.ts`
- `app/card-editor/utils/id-generator.ts`

#### å…·ä½“æ¸…ç†ï¼š
1. **åˆ é™¤æ—§çš„IDç”Ÿæˆå‡½æ•°**ï¼š
```typescript
// åˆ é™¤ generateCardId å‡½æ•°ï¼Œç»Ÿä¸€ä½¿ç”¨ generateSmartCardId
```

2. **ç®€åŒ–Propsæ¥å£**ï¼š
```typescript
// é‡æ„å‰
interface BaseCardFormProps<T> {
  card: T
  onSave: (card: T) => void
  onCancel?: () => void
  onPreview?: (card: T) => void
  onChange?: (card: T) => void
  customFields?: string[]
  keywordLists?: {...}
  onAddKeyword?: (category: string, keyword: string) => void
  packageInfo?: {
    name: string
    author: string
  }
  packageData?: any
}

// é‡æ„å
interface BaseCardFormProps<T> {
  card: T
  cardIndex: number
  cardType: CardType
  keywordLists?: {...}
  onAddKeyword?: (category: string, keyword: string) => void
}
```

3. **åˆ é™¤æœªä½¿ç”¨çš„importså’Œå˜é‡**

#### æµ‹è¯•éªŒè¯ï¼š
- TypeScriptç¼–è¯‘æ— é”™è¯¯
- æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

### æ­¥éª¤6ï¼šæœ€ç»ˆæµ‹è¯•å’Œä¼˜åŒ–
**ç›®æ ‡**ï¼šå…¨é¢æµ‹è¯•é‡æ„ç»“æœï¼Œç¡®ä¿åŠŸèƒ½å®Œæ•´

#### æµ‹è¯•æ¸…å•ï¼š
1. **åŸºæœ¬åŠŸèƒ½æµ‹è¯•**ï¼š
   - [ ] åˆ›å»ºæ–°å¡ç‰Œ
   - [ ] ç¼–è¾‘å¡ç‰Œå†…å®¹
   - [ ] åˆ é™¤å¡ç‰Œ
   - [ ] å¤åˆ¶å¡ç‰Œ

2. **IDç”Ÿæˆæµ‹è¯•**ï¼š
   - [ ] ä¿®æ”¹å¡ç‰Œåç§°ï¼ŒIDè‡ªåŠ¨æ›´æ–°
   - [ ] ä¿®æ”¹å¡åŒ…åç§°ï¼Œæ‰€æœ‰å¡ç‰ŒIDè‡ªåŠ¨æ›´æ–°
   - [ ] ä¿®æ”¹ä½œè€…åç§°ï¼Œæ‰€æœ‰å¡ç‰ŒIDè‡ªåŠ¨æ›´æ–°
   - [ ] IDå”¯ä¸€æ€§æ£€æŸ¥æ­£å¸¸å·¥ä½œ

3. **æ•°æ®æŒä¹…åŒ–æµ‹è¯•**ï¼š
   - [ ] é¡µé¢åˆ·æ–°åæ•°æ®ä¿æŒ
   - [ ] åˆ‡æ¢æ ‡ç­¾é¡µåæ•°æ®ä¸€è‡´
   - [ ] å¯¼å…¥å¯¼å‡ºåŠŸèƒ½æ­£å¸¸

4. **æ€§èƒ½æµ‹è¯•**ï¼š
   - [ ] å¤§é‡å¡ç‰Œæ—¶ç¼–è¾‘å“åº”æ­£å¸¸
   - [ ] å†…å­˜ä½¿ç”¨åˆç†

#### æ€§èƒ½ä¼˜åŒ–ï¼š
1. **å‡å°‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“**
2. **ä¼˜åŒ–IDç”Ÿæˆç®—æ³•**
3. **æ·»åŠ é€‚å½“çš„useMemoå’ŒuseCallback**

## é¢„æœŸæ•ˆæœ

### è§£å†³çš„é—®é¢˜ï¼š
- âœ… ä¿®æ”¹å¡åŒ…åç§°æ—¶ï¼Œæ‰€æœ‰å¡ç‰ŒIDè‡ªåŠ¨æ›´æ–°
- âœ… é¡µé¢åˆ‡æ¢æ—¶æ•°æ®ä¿æŒä¸€è‡´ï¼Œä¸å†æ˜¾ç¤º"æ–°å»ºå¡åŒ…"
- âœ… æ•°æ®æµç®€åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œè°ƒè¯•
- âœ… ç§»é™¤é‡å¤çš„IDç”Ÿæˆé€»è¾‘

### æ¶æ„æ”¹è¿›ï¼š
- **æ•°æ®æµ**ï¼šä»4å±‚ç®€åŒ–ä¸º2å±‚
- **ä»£ç é‡**ï¼šå‡å°‘çº¦30%çš„å†—ä½™ä»£ç 
- **ç»´æŠ¤æ€§**ï¼šé›†ä¸­åŒ–çš„æ•°æ®æ“ä½œé€»è¾‘
- **æ€§èƒ½**ï¼šå‡å°‘ä¸å¿…è¦çš„propsä¼ é€’

### é£é™©æ§åˆ¶ï¼š
- åˆ†æ­¥éª¤å®æ–½ï¼Œæ¯æ­¥å®Œæˆåæµ‹è¯•
- ä½¿ç”¨Gitç‰ˆæœ¬æ§åˆ¶ï¼Œå¯éšæ—¶å›é€€
- ä¿æŒç°æœ‰åŠŸèƒ½å®Œæ•´æ€§

## æ€»ç»“

è¿™æ¬¡é‡æ„çš„æ ¸å¿ƒæ˜¯å›å½’æœ¬è´¨ï¼š**æˆ‘ä»¬åªæ˜¯åœ¨ç¼–è¾‘ä¸€ä¸ªJSONæ–‡ä»¶**ã€‚é€šè¿‡å®ç°çœŸæ­£çš„å•ä¸€æ•°æ®æºå’Œç›´æ¥çš„æ•°æ®æµï¼Œæˆ‘ä»¬å°†å½»åº•è§£å†³å½“å‰çš„IDç”Ÿæˆé—®é¢˜å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒæ—¶å¤§å¹…ç®€åŒ–ä»£ç ç»“æ„ï¼Œæé«˜å¯ç»´æŠ¤æ€§ã€‚
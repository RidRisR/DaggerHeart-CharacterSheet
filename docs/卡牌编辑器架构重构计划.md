# 卡牌编辑器架构重构计划

## 重构目标

### 现有问题
1. **ID生成问题**：修改卡包名称后，卡牌ID不会自动更新
2. **数据流混乱**：4层数据传递，多个默认值定义，容易出现数据不一致
3. **页面切换问题**：切换页面后卡包名称显示为"新建卡包"
4. **维护困难**：相同的ID生成逻辑散布在多个组件中

### 重构原理
**核心洞察**：我们只是在编辑一个JSON文件，理想的架构应该是：
```
JSON数据 ← → Store ← → UI
```

### 目标架构
- **JSON是唯一真实数据源**
- **Store只是JSON的操作层**
- **UI只是JSON的展示层**
- **任何修改都直接修改JSON，其他一切自动同步**

## 重构计划（6个步骤）

### 步骤1：Store层重构 - 集中数据操作 ✅ 已完成
**目标**：将所有数据操作集中到store，实现自动ID管理

#### 修改文件：
- `app/card-editor/store/card-editor-store.ts` ✅

#### 具体修改：
1. **增强updateCard方法**：
```typescript
// 重构前
updateCard: (type, index, card) =>
  set(state => ({
    packageData: {
      ...state.packageData,
      [type]: state.packageData[type].map((c, i) => i === index ? card : c)
    }
  }))

// 重构后
updateCard: (type, index, updates) =>
  set(state => {
    const newCard = { ...state.packageData[type][index], ...updates }

    // 自动处理ID生成
    if (updates.名称) {
      newCard.id = generateSmartCardId(
        state.packageData.name || '新建卡包',
        state.packageData.author || '未知作者',
        type,
        updates.名称,
        state.packageData
      )
    }

    return {
      packageData: {
        ...state.packageData,
        [type]: state.packageData[type].map((c, i) => i === index ? newCard : c)
      }
    }
  })
```

2. **增强updateMetadata方法**：
```typescript
// 重构后 - 包名/作者变化时自动更新所有卡牌ID
updateMetadata: (field, value) =>
  set(state => {
    const newPackageData = { ...state.packageData, [field]: value }

    // 如果修改的是包名或作者，重新生成所有卡牌ID
    if (field === 'name' || field === 'author') {
      const cardTypes: CardType[] = ['profession', 'ancestry', 'community', 'subclass', 'domain', 'variant']

      cardTypes.forEach(cardType => {
        if (newPackageData[cardType] && Array.isArray(newPackageData[cardType])) {
          newPackageData[cardType] = newPackageData[cardType].map(card => ({
            ...card,
            id: generateSmartCardId(
              newPackageData.name || '新建卡包',
              newPackageData.author || '未知作者',
              cardType,
              card.名称 || '未命名',
              newPackageData
            )
          }))
        }
      })
    }

    return { packageData: newPackageData }
  })
```

#### 实际修改内容：
1. **添加了generateSmartCardId导入**
2. **重构了updateCard方法**：
   - 参数从`card`改为`updates`（支持部分更新）
   - 添加自动ID生成逻辑，当名称变化时重新生成ID
   - 增加边界检查，防止访问不存在的卡牌

3. **重构了updateMetadata方法**：
   - 当包名或作者变化时，自动更新所有卡牌的ID
   - 遍历所有卡牌类型，确保ID一致性

#### 测试验证 🔍 需要验证：
- [ ] 修改卡包名称，验证所有卡牌ID是否自动更新
- [ ] 修改作者名称，验证所有卡牌ID是否自动更新
- [ ] 修改卡牌名称，验证该卡牌ID是否自动更新
- [ ] 确保其他卡牌功能（添加、删除、复制）仍正常工作

---

### 步骤2：移除表单组件的ID生成逻辑 ✅ 已完成
**目标**：清理表单组件，移除重复的ID生成代码

#### 修改文件：
- `components/card-editor/card-form.tsx` ✅
- `components/card-editor/ancestry-dual-card-form.tsx` ✅ (已有正确的onBlur)
- `components/card-editor/subclass-triple-card-form.tsx` ✅ (已有正确的onBlur)

#### 具体修改：
1. **移除所有ID相关的useEffect**：
```typescript
// 删除以下代码块
// 监听名称字段变化，自动更新ID (第105-122行)
// 初始化时如果没有ID或ID为默认值，则自动生成 (第125-139行)
```

2. **移除ID相关的state和函数**：
```typescript
// 删除
const [isEditingId, setIsEditingId] = useState(false)
const [autoGenerateId, setAutoGenerateId] = useState(true)
const generateId = () => { ... }
```

3. **移除ID编辑UI**：
```typescript
// 删除职业名称字段中的ID显示和编辑部分 (第190-258行)
```

4. **简化handleFieldBlur**：
```typescript
// 重构前
const handleFieldBlur = () => {
  setTimeout(() => {
    handleAutoSave()
  }, 100)
}

// 重构后 - 直接调用
const handleFieldBlur = () => {
  handleAutoSave()
}
```

#### 实际修改内容：
1. **完全重写了card-form.tsx**：
   - 移除所有ID生成相关的state：`isEditingId`, `autoGenerateId`
   - 移除所有ID生成相关的useEffect（名称监听、初始化生成）
   - 移除ID编辑UI界面（ID显示、编辑按钮、自动生成切换）
   - 移除手动生成ID函数
   - 简化handleFieldBlur，去掉setTimeout包装
   - 保留了职业简介的非必填修改

2. **备份原文件**：
   - 原文件已备份为 `card-form-backup.tsx`
   - 新文件大幅简化，只保留核心表单功能

3. **其他表单文件**：
   - `ancestry-dual-card-form.tsx` 和 `subclass-triple-card-form.tsx` 已在步骤1中正确添加onBlur，无需修改

#### 测试验证 🔍 需要验证：
- [ ] 职业卡表单能正常显示和编辑
- [ ] 表单数据修改能正确保存到store（通过onSave）
- [ ] KeywordCombobox的onBlur触发正常工作
- [ ] 其他卡牌类型（种族、变体等）暂时显示占位符但不影响功能
- [ ] ID生成现在完全由store自动处理

---

### 步骤3：简化组件props传递
**目标**：移除packageInfo props，组件直接从store获取数据

#### 修改文件：
- `app/card-editor/components/card-tabs/card-editor-tab.tsx`
- `components/card-editor/card-form.tsx`

#### card-editor-tab.tsx修改：
```typescript
// 重构前
const commonProps = {
  card: currentCard,
  onSave: (updatedCard: unknown) => onUpdateCard(cardType, safeIndex, updatedCard),
  onChange: handleFormChange,
  keywordLists: currentPackage.customFieldDefinitions,
  onAddKeyword: handleAddKeyword,
  packageInfo: {
    name: currentPackage.name || '未命名卡包',
    author: currentPackage.author || '未知作者'
  }
}

// 重构后 - 移除packageInfo
const commonProps = {
  card: currentCard,
  cardIndex: safeIndex,
  cardType: cardType,
  keywordLists: currentPackage.customFieldDefinitions,
  onAddKeyword: handleAddKeyword,
}
```

#### card-form.tsx修改：
```typescript
// 重构前
export function ProfessionCardForm({
  card,
  onSave,
  onChange,
  keywordLists,
  onAddKeyword,
  packageInfo,    // 删除
  packageData     // 删除
}: BaseCardFormProps<ProfessionCard>) {

// 重构后
export function ProfessionCardForm({
  card,
  cardIndex,
  cardType,
  keywordLists,
  onAddKeyword
}: BaseCardFormProps<ProfessionCard>) {
  const { updateCard } = useCardEditorStore()  // 直接使用store
```

#### 测试验证：
- 组件能正确渲染
- 数据修改能正确保存到store

---

### 步骤4：重构表单数据流
**目标**：表单直接与store交互，移除中间层

#### 修改文件：
- `components/card-editor/card-form.tsx`（所有表单组件）

#### 具体修改：
```typescript
// 重构前 - 通过props层层传递
const handleAutoSave = () => {
  const currentData = form.getValues()
  onSave(currentData)  // 通过props调用
}

// 重构后 - 直接调用store
const handleAutoSave = () => {
  const currentData = form.getValues()
  updateCard(cardType, cardIndex, currentData)  // 直接调用store
}
```

```typescript
// 重构前 - 复杂的onChange处理
useEffect(() => {
  if (!onChange) return
  const subscription = form.watch((value) => {
    onChange(value as ProfessionCard)
  })
  return () => subscription.unsubscribe()
}, [form, onChange])

// 重构后 - 简单的实时保存
useEffect(() => {
  const subscription = form.watch((value) => {
    updateCard(cardType, cardIndex, value)
  })
  return () => subscription.unsubscribe()
}, [form, cardType, cardIndex, updateCard])
```

#### 测试验证：
- 表单实时保存功能正常
- 数据变化立即反映在其他组件中

---

### 步骤5：清理冗余代码和接口
**目标**：删除不再需要的代码，简化类型定义

#### 修改文件：
- `components/card-editor/card-form.tsx`
- `app/card-editor/types/index.ts`
- `app/card-editor/utils/id-generator.ts`

#### 具体清理：
1. **删除旧的ID生成函数**：
```typescript
// 删除 generateCardId 函数，统一使用 generateSmartCardId
```

2. **简化Props接口**：
```typescript
// 重构前
interface BaseCardFormProps<T> {
  card: T
  onSave: (card: T) => void
  onCancel?: () => void
  onPreview?: (card: T) => void
  onChange?: (card: T) => void
  customFields?: string[]
  keywordLists?: {...}
  onAddKeyword?: (category: string, keyword: string) => void
  packageInfo?: {
    name: string
    author: string
  }
  packageData?: any
}

// 重构后
interface BaseCardFormProps<T> {
  card: T
  cardIndex: number
  cardType: CardType
  keywordLists?: {...}
  onAddKeyword?: (category: string, keyword: string) => void
}
```

3. **删除未使用的imports和变量**

#### 测试验证：
- TypeScript编译无错误
- 所有功能正常工作

---

### 步骤6：最终测试和优化
**目标**：全面测试重构结果，确保功能完整

#### 测试清单：
1. **基本功能测试**：
   - [ ] 创建新卡牌
   - [ ] 编辑卡牌内容
   - [ ] 删除卡牌
   - [ ] 复制卡牌

2. **ID生成测试**：
   - [ ] 修改卡牌名称，ID自动更新
   - [ ] 修改卡包名称，所有卡牌ID自动更新
   - [ ] 修改作者名称，所有卡牌ID自动更新
   - [ ] ID唯一性检查正常工作

3. **数据持久化测试**：
   - [ ] 页面刷新后数据保持
   - [ ] 切换标签页后数据一致
   - [ ] 导入导出功能正常

4. **性能测试**：
   - [ ] 大量卡牌时编辑响应正常
   - [ ] 内存使用合理

#### 性能优化：
1. **减少不必要的重新渲染**
2. **优化ID生成算法**
3. **添加适当的useMemo和useCallback**

## 预期效果

### 解决的问题：
- ✅ 修改卡包名称时，所有卡牌ID自动更新
- ✅ 页面切换时数据保持一致，不再显示"新建卡包"
- ✅ 数据流简化，易于维护和调试
- ✅ 移除重复的ID生成逻辑

### 架构改进：
- **数据流**：从4层简化为2层
- **代码量**：减少约30%的冗余代码
- **维护性**：集中化的数据操作逻辑
- **性能**：减少不必要的props传递

### 风险控制：
- 分步骤实施，每步完成后测试
- 使用Git版本控制，可随时回退
- 保持现有功能完整性

## 总结

这次重构的核心是回归本质：**我们只是在编辑一个JSON文件**。通过实现真正的单一数据源和直接的数据流，我们将彻底解决当前的ID生成问题和数据一致性问题，同时大幅简化代码结构，提高可维护性。
# 社群卡牌功能开发记录

## 概述

本文档记录了为 DaggerHeart 角色卡系统添加社群卡牌编辑功能的完整开发过程。社群卡牌是 DaggerHeart 游戏中的核心卡牌类型之一，用于定义角色的社会背景和团体关系。

### 社群卡牌字段结构
```typescript
interface CommunityCard {
  id: string          // 唯一标识符
  名称: string        // 社群名称
  特性: string        // 社群能力（简单文本）
  简介: string        // 社群简介
  描述: string        // 社群详细描述（支持Markdown）
}
```

### 功能特点
- 智能输入：社群名称支持关键词自动补全和创建新选项
- 布局一致：与职业卡、血统卡保持相同的编辑体验
- 实时预览：右侧实时显示卡牌预览效果
- ID自动生成：支持智能ID生成和手动编辑

---

## 开发步骤详记

### 1. KeywordCombobox 组件开发

**目的**：替换原有的下拉选择框，提供更友好的输入体验

**创建文件**：`components/card-editor/keyword-combobox.tsx`

**核心功能**：
- 直接文本输入
- 实时模糊匹配
- 高亮匹配文字
- 键盘导航（上下键、Enter、Esc）
- 自动创建新选项
- 防抖处理

**关键技术点**：
```typescript
// 防止无限循环的setValue调用
if (form.getValues('id') !== newId) {
  form.setValue('id', newId, { 
    shouldValidate: false, 
    shouldDirty: false, 
    shouldTouch: false 
  })
}
```

### 2. 修复表单无限循环问题

**问题**：form.watch 监听名称变化时，setValue 触发新的 watch 事件导致栈溢出

**影响范围**：ProfessionCardForm, AncestryCardForm, VariantCardForm

**解决方案**：
1. 添加ID值比较，只在实际需要时更新
2. 使用 shouldValidate: false 等选项避免触发额外更新
3. 在依赖数组中添加 packageData

**修改文件**：`components/card-editor/card-form.tsx`

### 3. CommunityCardForm 组件开发

**创建位置**：`components/card-editor/card-form.tsx` 末尾

**布局结构**（与卡牌显示布局一致）：
1. **第一行**：社群名称（占一半宽度，包含ID管理）
2. **第二行**：社群能力（简单文本输入）
3. **第三行**：社群描述（Markdown编辑器）
4. **第四行**：社群简介（简单文本输入）

**核心特性**：
- 集成了修复后的无限循环防护逻辑
- 使用新的 KeywordCombobox 组件
- 完整的表单验证和错误处理
- 与其他卡牌表单完全一致的交互体验

### 4. 系统类型定义更新

**文件1**：`components/card-editor/card-form.tsx`
```typescript
// 添加导入
import type { CommunityCard } from '@/card/community-card/convert'
```

**文件2**：`app/card-editor/types/index.ts`
```typescript
// 更新CardData联合类型
export type CardData = ProfessionCard | AncestryCard | CommunityCard | RawVariantCard

// 导入社群卡类型
import type { CommunityCard } from '@/card/community-card/convert'
```

### 5. 编辑器Tab集成

**文件1**：`app/card-editor/components/card-tabs/card-editor-tab.tsx`

**修改内容**：
1. 导入 CommunityCardForm
2. 在 getActionText() 中添加 'community' case
3. 在 getCardForm() switch 语句中添加社群卡处理逻辑

```typescript
case 'community':
  return <CommunityCardForm {...commonProps} />
```

**文件2**：`app/card-editor/components/card-tabs/index.tsx`

**修改内容**：
1. 将 community 从占位符数组中移除
2. 创建专门的 TabsContent 使用 CardEditorTab 组件

```typescript
{/* 社群卡牌选项卡 */}
<TabsContent value="community">
  <CardEditorTab
    {...cardEditorProps}
    cardType="community"
    title="社群卡牌"
  />
</TabsContent>
```

### 6. 实时预览功能集成

**文件**：`app/card-editor/utils/card-transformer.ts`

**添加内容**：
1. 导入社群卡类型和转换器
2. 创建 transformCommunityCard 函数
3. 更新 transformCardToStandard 函数支持 community 类型

```typescript
case 'community':
  return transformCommunityCard(card as CommunityCard)
```

### 7. UI优化调整

**调整1**：血统卡名称字段改为占一半宽度
- 修改布局为 `grid-cols-1 md:grid-cols-2`，与职业卡保持一致

**调整2**：社群能力字段优化
- 标签从"社群特性"改为"社群能力"
- 从 MarkdownEditor 改为普通 Input 输入框
- 更新占位符和描述文本

---

## 文件修改清单

### 新建文件
- `components/card-editor/keyword-combobox.tsx` - 智能输入组件

### 修改文件

#### 核心组件文件
- `components/card-editor/card-form.tsx`
  - 添加 CommunityCardForm 组件
  - 修复所有表单的无限循环问题
  - 导入相关类型

#### 编辑器集成文件
- `app/card-editor/components/card-tabs/card-editor-tab.tsx`
  - 集成 CommunityCardForm 到编辑器
  - 添加社群卡的处理逻辑

- `app/card-editor/components/card-tabs/index.tsx`
  - 添加社群卡专用的 TabsContent
  - 移除占位符处理

#### 类型定义文件
- `app/card-editor/types/index.ts`
  - 更新 CardData 联合类型
  - 导入 CommunityCard 类型

#### 预览功能文件
- `app/card-editor/utils/card-transformer.ts`
  - 添加社群卡转换逻辑
  - 支持实时预览功能

---

## 技术难点和解决方案

### 1. 表单无限循环问题

**问题描述**：form.watch 监听字段变化时，setValue 会触发新的 watch 事件

**解决方案**：
```typescript
// 只在ID实际需要更新时才设置，避免无限循环
if (form.getValues('id') !== newId) {
  form.setValue('id', newId, { 
    shouldValidate: false, 
    shouldDirty: false, 
    shouldTouch: false 
  })
}
```

### 2. KeywordCombobox 创建新选项的字符串解析

**问题描述**：解析创建新选项时的字符串索引错误

**解决方案**：
```typescript
// '__create__:' 长度为11，不是10
const newKeyword = option.substring(11)  // 正确
```

### 3. 实时预览不更新

**问题描述**：社群卡编辑时右侧预览不跟随变化

**解决方案**：在 card-transformer.ts 中添加社群卡的转换逻辑

---

## 开发经验总结

### 成功经验

1. **组件复用**：KeywordCombobox 组件可以轻松应用到所有关键词输入场景
2. **一致性设计**：严格按照现有模式开发，确保用户体验统一
3. **渐进式开发**：先修复现有问题，再添加新功能，降低复杂度

### 注意事项

1. **类型安全**：确保所有新增类型都在相关联合类型中正确声明
2. **组件集成**：新组件需要在多个层级正确集成（表单→编辑器→选项卡）
3. **预览功能**：新卡牌类型必须添加相应的转换逻辑才能支持实时预览

### 后续扩展建议

1. **子职业卡**：可以参考社群卡的开发模式，注意子职业的复杂字段结构
2. **领域卡**：需要支持数字类型字段（等级、回想值）
3. **批量操作**：考虑添加批量编辑、导入导出等功能

---

## 测试验证

### 功能测试
- [x] 社群卡创建和编辑
- [x] 智能输入和关键词管理
- [x] 实时预览更新
- [x] ID自动生成和手动编辑
- [x] 表单验证和错误处理

### 兼容性测试
- [x] 与现有职业卡、血统卡功能无冲突
- [x] 导入导出功能正常
- [x] 移动端响应式布局正常

---

**开发完成时间**：2025年1月
**开发者**：Claude Code AI Assistant
**版本**：DaggerHeart CharacterSheet v1.0

---

*本文档记录了社群卡牌功能的完整开发过程，为后续功能扩展和维护提供参考。*